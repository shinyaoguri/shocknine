<!DOCTYPE html>

<html lang="ja">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="description" content="school lunch app">
    <meta name="author" content="shinya oguri">
    <meta name="viewport" content="width=device-width,height=device-height,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no,viewport-fit=cover">
    <meta name="theme-color" content="#5E3B4D">
    <title>shocknine</title>

    <!-- for pwa -->
    <link rel="manifest" href="manifest.json">

    <!-- favicon -->
    <link rel="icon" type="image/png" sizes="16x16" href="images/favicon-16x16.png">
    <link rel="icon" type="image/png" sizes="32x32" href="images/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="96x96" href="images/favicon-96x96.png">
    <link rel="icon" type="image/png" sizes="192x192"  href="images/android-icon-192x192.png">


    <!-- CSS -->
    <link rel="stylesheet" href="//unpkg.com/onsenui@2.10.6/css/onsenui.css">
    <link rel="stylesheet" href="//unpkg.com/onsenui@2.10.6/css/onsen-css-components.min.css">

    <!-- JS -->
    <script type="text/javascript" src="//cdn.jsdelivr.net/npm/vue@2.5.17/dist/vue.js"></script>
    <script type="text/javascript" src="//unpkg.com/onsenui@2.10.6/js/onsenui.min.js"></script>
    <script type="text/javascript" src="//unpkg.com/vue-onsenui@2.6.1/dist/vue-onsenui.js"></script>
    <script type="text/javascript" src="//unpkg.com/vuex@3.0.1/dist/vuex.js"></script>

    <!-- mobile Safari -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="shocknine">

    <!-- ios Icon Image-->
    <!-- iPhone+ (6+,6S+,7+,8+,X,XS,XS Max,) [180x180]-->
    <link rel="apple-touch-icon" href="images/icon-ios/Icon-60@3x.png" sizes="180x180">
    <!-- iPhone (4,4S,5,5C,5S,6,6SE,6S,7,8) [120x120]-->
    <link rel="apple-touch-icon" href="images/icon-ios/Icon-60@2x.png" sizes="120x120">
    <!-- iPad Pro [167x167]-->
    <link rel="apple-touch-icon" href="images/icon-ios/Icon-167.png" sizes="167x167">
    <!-- Retina iPads (Mini2&3,Air,3&4 ) [152x152]-->
    <link rel="apple-touch-icon" href="images/icon-ios/Icon-76@2x.png" sizes="152x152">

    <!-- ios Splash Image-->
    <!-- iPhone 5, SE [640x1136]-->
    <link rel="apple-touch-startup-image"
          href="images/splash/iPhone5SE-640x1136@2x.png"
          media="(device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)">
    <link rel="apple-touch-startup-image"
          href="images/splash/iPhone5SE-640x1136@2x.png"
          media="(device-width: 568px) and (device-height: 320px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)">
    <!-- iPhone 6, 6s, 7, 8 [750x1334]-->
    <link rel="apple-touch-startup-image"
          href="images/splash/iPhone678-750x1334@2x.png"
          media="(device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)">
    <link rel="apple-touch-startup-image"
          href="images/splash/iPhone678-750x1334@2x.png"
          media="(device-width: 667px) and (device-height: 375px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)">
    <!-- iPhone 6, 7, 8 Plus [1242x2208]-->
    <link rel="apple-touch-startup-image"
          href="images/splash/iPhone678Plus-828x1472@3x.png"
          media="(device-width: 414px) and (device-height: 736px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)">
    <link rel="apple-touch-startup-image"
          href="images/splash/iPhone678Plus-828x1472@3x.png"
          media="(device-width: 736px) and (device-height: 414px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)">
    <!-- iPhone X, XS [1125x2436]-->
    <link rel="apple-touch-startup-image"
          href="images/splash/iPhoneX-750x1624@3x.png"
          media="(device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)">
    <link rel="apple-touch-startup-image"
          href="images/splash/iPhoneX-750x1624@3x.png"
          media="(device-width: 812px) and (device-height: 375px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)">
    <!-- iPhone Xr [828x1792]-->
    <link rel="apple-touch-startup-image"
          href="/apple-launch-828x1792.png"
          media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)">
    <link rel="apple-touch-startup-image"
          href="/apple-launch-828x1792.png"
          media="(device-width: 896px) and (device-height: 414px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)">
    <!-- iPhone Xs Max [1242x2688]-->
    <link rel="apple-touch-startup-image"
          href="/apple-launch-1242x2688.png"
          media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)">
    <link rel="apple-touch-startup-image"
          href="/apple-launch-1242x2688.png"
          media="(device-width: 896px) and (device-height: 414px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)">
    <!-- iPad 3,4,Air,Air2,Pro 9.7 [1536x2048]-->
    <link rel="apple-touch-startup-image"
          href="images/splash/iPad-1536x2048@2x.png"
          media="(device-width: 768px) and (device-height: 1024px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)">
    <link rel="apple-touch-startup-image"
          href="images/splash/iPad-1536x2048@2x.png"
          media="(device-width: 1024px) and (device-height: 768px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)">
    <!-- iPad Pro 10.5 [1688x2224]-->
    <link rel="apple-touch-startup-image"
          href="images/splash/iPadPro10-1688x2224@2x.png"
          media="(device-width: 834px) and (device-height: 1112px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)">
    <link rel="apple-touch-startup-image"
          href="images/splash/iPadPro10-1688x2224@2x.png"
          media="(device-width: 1112px) and (device-height: 834px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)">
    <!-- iPad Pro 11 [1668x2388]-->
    <link rel="apple-touch-startup-image"
          href="images/splash/iPadPro11-1668x2388@2x.png"
          media="(device-width: 1024px) and (device-height: 1366px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)">
    <link rel="apple-touch-startup-image"
          href="images/splash/iPadPro11-1668x2388@2x.png"
          media="(device-width: 1366px) and (device-height: 1024px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)">
    <!-- iPad Pro 12.9 [2048x2732]-->
    <link rel="apple-touch-startup-image"
          href="images/splash/iPadPro12-2048x2732@2x.png"
          media="(device-width: 1024px) and (device-height: 1366px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)">
    <link rel="apple-touch-startup-image"
          href="images/splash/iPadPro12-2048x2732@2x.png"
          media="(device-width: 1366px) and (device-height: 1024px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)">
</head>

<body style="position:fixed;">
<!-- navigator -->
<template id="main">
    <v-ons-navigator :page-stack="pageStack"></v-ons-navigator>
</template>

<!-- tabbar -->
<template id="tabbar">
    <v-ons-page>
        <v-ons-toolbar>
            <div class="center">{{ title }}</div>
        </v-ons-toolbar>

        <v-ons-tabbar swipeable
                      position="bottom"
                      :tabs="tabs"
                      :index.sync="index"
        >
        </v-ons-tabbar>
    </v-ons-page>
</template>

<!-- tab 1/4 -->
<template id="tab_home">
    <v-ons-page>
        <v-ons-pull-hook
                :action="onAction"
                :fixed-content="md"
                :height="md ? 84 : 64"
                :on-pull="md && onPull || null"
                @changestate="pullhookstate = $event.state"
        >

            <!-- Show this on iOS -->
            <v-ons-icon v-if="!md"
                        size="22px"
                        class="pull-hook-spinner"
                        :icon="pullhookstate === 'action' ? 'fa-spinner' : 'fa-arrow-down'"
                        :rotate="pullhookstate === 'preaction' && 180"
                        :spin="pullhookstate === 'action'"
            ></v-ons-icon>

            <!-- Show this on Material Design -->
            <div v-else class="pull-hook-progress">
                <v-ons-progress-circular
                        :value="ratio * 100"
                        :indeterminate="state === 'action'"
                        :style="{ transform: 'rotate(${ratio}turn)' }"
                ></v-ons-progress-circular>
            </div>
        </v-ons-pull-hook>

        <div class="menu-image">
            <img class="todays-image" :src="imageSrc" onerror="this.src='http://hoge.main.jp/handa-lunch-od/noimg.png'">
            <p>{{ todayStr }}</p>
        </div>
        <v-ons-list v-for="item in todaysMenu.data.menu" :key="item.name">
            <v-ons-list-header>
                {{item.type}}
            </v-ons-list-header>
            <v-ons-list-item>
                {{item.name}}
            </v-ons-list-item>

        </v-ons-list>

    </v-ons-page>
</template>

<!-- tab 2/4 -->
<template id="tab_calendar">
    <v-ons-page>
        <div id="calendar-nav">
            <button @click="moveLastMonth()">
                <v-ons-icon icon="fa-angle-left"></v-ons-icon>
            </button>
            <span>{{calData.year}} - {{getMonthName(calData.month)}}</span>
            <button @click="moveNextMonth()"><i class="fa fa-angle-right" aria-hidden="true"></i></button>
        </div>
        <table id="calendar" class="table table-bordered">
            <thead>
            <tr>
                <th v-for="week in weeks">{{week}}</th>
            </tr>
            </thead>
            <tbody>
            <tr v-for="week in calendar">
                <td v-for="day in week">{{day.day}}</td>
            </tr>
            </tbody>
        </table>
    </v-ons-page>
</template>

<!-- tab 3/4 -->
<template id="tab_search">
    <v-ons-page>
        <p style="text-align: center; margin-top: 10px;">
            <ons-search-input
                    placeholder="検索"
            ></ons-search-input>
        </p>
    </v-ons-page>
</template>

<!-- tab 4/4 -->
<template id="tab_settings">
    <v-ons-page>
    </v-ons-page>
</template>

<!-- app -->
<div id="app"></div>

<script>
////////////////
// Service Worker
////////////////
window.addEventListener('load', function() {
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register("sw.js")
            .then(function(registration) {
                console.log("serviceWorker registed.");
            }).catch(function(error) {
            console.warn("serviceWorker error.", error);
        });
    }
});

////////////////
// Vuex
////////////////
const store = new Vuex.Store({
    modules: {
        navigator: {
            strict: true,
            namespaced: true,
            state: {
                stack: [],
                options: {}
            },
            mutations: {
                push (state, page) {
                    state.stack.push(page)
                },
                pop (state) {
                    if (state.stack.length() > 1) {
                        state.stack.pop()
                    }
                },
                replace (state, page) {
                    state.stack.pop()
                    state.stack.push(page)
                },
                reset (state, page) {
                    state.stack = [page || state.stack[0]]
                },
                options (state, newOptions = {}) {
                    state.options = newOptions
                }
            }
        },
        splitter: {
            strict: true,
            namespaced: true,
            state: {
                open: false
            },
            mutations: {
                toggle(state, shouldOpen) {
                    if (typeof shouldOpen === 'boolean') {
                        state.open = shouldOpen
                    } else {
                        state.open = !state.open
                    }
                }
            }
        },
        tabbar: {
            strict: true,
            namespaced: true,
            state: {
                activeIndex: 0
            },
            mutations: {
                set (state, index) {
                    state.activeIndex = index
                }
            }
        }
    }
});

////////////////
// tabs
////////////////
const tabHome = {
    template: '#tab_home',
    data: function () {
        return {
            pullhookstate: 'initial',
            ratio: 0,
            now: null,
            imageSrc: this.getTodayMenuImgPath(),
            dayPath: this.getTodayMenuImgPath(),
            todayStr: this.getTodayStr(),
            todaysMenu: {
                id: 20180611,
                data: {
                    year: 2018,
                    month: 6,
                    date: 11,
                    day: 1,
                    menuExist: true,
                    cal_s: 668,
                    cal_c: 847,
                    menu: [
                        {
                            type: 'main',
                            name: 'ごはん'
                        },
                        {
                            type: 'sub',
                            name: '★はるまき'
                        },
                        {
                            type: 'sub',
                            name: 'ぶたキムチいため'
                        },
                        {
                            type: 'sub',
                            name: 'ちゅうかふうたまごスープ'
                        },
                        {
                            type: 'drink',
                            name: '牛乳'
                        }
                    ]
                }
            }
        }
    },
    created: function () {
        this.now = new Date()
        setInterval(() => {
            // this.now = new Date()
            // console.log('hoge')
        }, 100)
    },
    computed: {
        today: function () {
            return this.now.getSeconds()
        }
    },
    methods: {
        onPull (ratio) {
            this.ratio = ratio
        },
        onAction (done) {
            setTimeout(() => {
                this.imageSrc = this.getTodayMenuImgPath()
                done()
            }, 1500)
        },
        getTodayMenuImgPath: function () {
            var day = new Date()
            var dayStr = day.getFullYear() + '' + ('00' + (day.getMonth() + 1)).slice(-2) + '' + ('00' + day.getDate()).slice(-2)

            return 'http://hoge.main.jp/handa-lunch-od/' + dayStr + '.jpg'
        },
        getTodayStr: function () {
            var day = new Date()
            var today = (day.getMonth() + 1) + '月' + day.getDate() + '日'
            return today
        }
    }
};
const tabCalendar = {
    template: '#tab_calendar',
    data: function () {
        return {
            weeks: ['日', '月', '火', '水', '木', '金', '土'],
            calData: {year: 0, month: 0}
        }
    },
    created: function () {
        var date = new Date()
        this.calData.year = date.getFullYear()
        this.calData.month = date.getMonth() + 1
    },
    methods: {
        getMonthName: function (month) {
            var monthName = ['January','February','March','April','May','June','July','August','September','October','November','December']
            return monthName[month - 1]
        },
        getMonthJapaneseName: function (month) {
            var monthName = ['1月','2月','3月','4月','5月','6月','7月','8月','9月','10月','11月','12月']
            return monthName[month - 1]
        },
        moveLastMonth: function () {
            if (this.calData.month === 1) {
                this.calData.year--
                this.calData.month = 12
            }
            else {
                this.calData.month--
            }
        },
        moveNextMonth: function () {
            if (this.calData.month === 12) {
                this.calData.year++
                this.calData.month = 1
            }
            else {
                this.calData.month++
            }
        }
    },
    computed: {
        calendar: function () {
            // 1日の曜日
            var firstDay = new Date(this.calData.year, this.calData.month - 1, 1).getDay()
            // 晦日の日にち
            var lastDate = new Date(this.calData.year, this.calData.month, 0).getDate()
            // 日にちのカウント
            var dayIdx = 1
            var calendar = []
            for (let w = 0; w < 6; w++) {
                var week = []
                // 空白行をなくすため
                if (lastDate < dayIdx) {
                    break
                }
                for (let d = 0; d < 7; d++) {
                    if (w === 0 && d < firstDay) {
                        week[d] = {day: ''}
                    } else if (w === 6 && lastDate < dayIdx) {
                        week[d] = {day: ''}
                        dayIdx++
                    } else if (lastDate < dayIdx) {
                        week[d] = {day: ''}
                        dayIdx++
                    } else {
                        week[d] = {day: dayIdx}
                        dayIdx++
                    }
                }
                calendar.push(week)
            }
            return calendar
        }
    }
};
const tabSearch = {
    key: 'search',
    template: '#tab_search',
};

const tabSettings = {
    template: '#tab_settings',
};
const appTabbar = {
    template: '#tabbar',
    data: function () {
        return {
            tabs: [
                {
                    icon: 'fa-cutlery',
                    label: '今日の献立',
                    page: tabHome
                },
                {
                    icon: 'fa-table',
                    label: '献立表',
                    page: tabCalendar
                },
                {
                    icon: 'fa-search',
                    label: '検索',
                    page: tabSearch,
                    badge: 7
                },
                {
                    icon: 'fa-sliders',
                    label: '設定',
                    page: tabSettings
                }
            ]
        }
    },
    methods: {
    },
    computed: {
        index: {
            get () {
                return store.state.tabbar.activeIndex
            },
            set (newVal) {
                store.commit('tabbar/set', newVal)
            }
        },
        title: function () {
            return this.tabs[this.index].label
        }
    }
};

////////////////
// main
////////////////
new Vue({
    el: '#app',
    template: '#main',
    store: store,
    data: function() {
        return {
        }
    },
    beforeCreate () {
        store.commit('navigator/push', appTabbar)
    },
    methods: {
        storePop: function () {
            this.$store.commit('navigator/pop')
        }
    },
    computed: {
        pageStack: function () {
            return this.$store.state.navigator.stack
        },
        options: function () {
            return this.$store.state.navigator.options
        }
    }
});
</script>

<style scoped>
    .menu-image {
        position: relative;
    }
    .menu-image p {
        position: absolute;
        top: 0px;
        left: 0px;
        margin: 0px;
        color: white;
        background: lightsalmon;
        font-size: 35px;
        line-height: 1;
        padding: 5px 15px;
        font-weight: bold;
    }
    .todays-image {
        width: 100%;
    }

    .pull-hook-spinner {
        color: #666;
        transition: transform .25s ease-in-out;
    }

    .pull-hook-progress {
        background-color: white;
        width: 32px;
        height: 32px;
        margin: 30px auto 0;
        border-radius: 100%;
        position: relative;
        box-shadow: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24);
        display: inline-block;
        line-height: 0px;
    }

    .pull-hook-progress .progress-circular {
        width: 24px;
        height: 24px;
        position: absolute;
        top: 4px;
        left: 4px;
    }

    .pull-hook-progress .progress-circular__primary {
        transition: stroke-dashoffset 0s;
    }

    /*カレンダー*/
    #calendar {
        width: 100%;
        height: 90%;
    }

    #calendar-nav {
        text-align: center;
        height: 10%;
    }

    #calendar-nav span {
        /*display: inline-block;*/
        /*width: 300px;*/
    }

    #calendar-nav i:hover {
        cursor: pointer;
    }

    /* カレンダーのスタイル */
    .table th, td{
        text-align: center;
    }

    #calendar th:first-child {
        background-color: #FEEEFF;
    }
    #calendar td:first-child {
        background-color: #FEEEFF;
    }
    #calendar th:nth-child(7) {
        background-color: #DFFFFF
    }
    #calendar td:nth-child(7) {
        background-color: #DFFFFF
    }

    #calendar td:hover {
        opacity: 0.6;
    }
</style>

</body>
</html>
